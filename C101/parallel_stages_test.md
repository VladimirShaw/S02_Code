# C101 并行环节测试指南

## 概述
C101 GameFlowManager 现已支持多个环节并行执行。这允许系统同时运行多个音频环节，实现更复杂的音频效果组合。

## 主要特性
- 最大支持 4 个环节并行执行（可通过 MAX_PARALLEL_STAGES 配置）
- 保持与原有单环节接口的兼容性
- 支持服务器发送的多环节跳转指令
- 每个环节独立管理自己的状态和时间

## 测试命令

### 1. 单环节启动（兼容原有方式）
```
# 启动单个环节
STEP@C101(session_id=test123,step_id="000_0")
```

### 2. 多环节并行启动
```
# 同时启动多个环节（逗号分隔）
STEP@C101(session_id=test123,step_id="000_0,001_2,002_0")

# 启动两个环节
STEP@C101(session_id=test123,step_id="000_0,002_0")
```

### 3. 查看并行环节状态
```
# 打印当前所有运行环节的状态
STATUS
```

### 4. 停止特定环节
```
# 停止指定环节（新增功能）
STOP_STAGE@C101(stage_id="001_2")
```

### 5. 停止所有环节
```
# 停止所有运行中的环节
STOP@C101(reason=test_complete)
```

## 环节完成通知

### 单环节完成
```
$[GAME]@C101{^STEP_COMPLETE^(current_step="000_0",next_step="001_1",duration=1000,error_count=0)}#
```

### 多环节跳转
```
$[GAME]@C101{^STEP_COMPLETE^(current_step="000_0",next_step="001_2,002_0",duration=1000,error_count=0)}#
```

## 测试场景

### 场景1：基础并行测试
1. 初始化系统：`INIT@C101(mode=test)`
2. 开始游戏：`START@C101(session_id=test123)`
3. 启动并行环节：`STEP@C101(session_id=test123,step_id="000_0,002_0")`
4. 观察两个环节同时运行
5. 等待环节完成通知

### 场景2：环节冲突测试
1. 启动环节000_0：`STEP@C101(session_id=test123,step_id="000_0")`
2. 尝试再次启动000_0：`STEP@C101(session_id=test123,step_id="000_0")`
3. 应该看到"环节已在运行"的提示

### 场景3：满载测试
1. 启动4个环节：`STEP@C101(session_id=test123,step_id="000_0,001_2,002_0,000_0")`
2. 尝试启动第5个环节（应该失败）
3. 停止一个环节后再试

### 场景4：级联跳转测试
1. 启动000_0环节
2. 等待000_0完成，自动跳转到001_1（需要先定义001_1环节）
3. 观察多环节跳转是否正常工作

## 注意事项

1. **音频通道冲突**：多个环节可能使用相同的音频通道，需要合理规划
2. **内存使用**：每个并行环节占用一定内存，Arduino内存有限
3. **状态独立性**：每个环节的状态完全独立，包括计时器和播放状态
4. **兼容性**：原有的单环节代码无需修改即可继续工作

## 调试信息

启用调试时，会看到类似以下信息：
```
=== 启动C101音频环节[槽位0]: 000_0 ===
=== 启动C101音频环节[槽位1]: 002_0 ===
🎵 [槽位0] 0ms: 通道2开始播放201
🎵 [槽位1] 0ms: 通道1开始播放2
🎵 [槽位1] 0ms: 通道2开始播放203
⏰ [槽位0] 环节000_0完成，跳转到001_1
```

## 性能考虑

- 每个update()周期会更新所有活跃环节
- 建议合理规划环节执行，避免同时运行过多复杂环节
- 音频命令发送需要适当间隔，避免语音模块处理不及时 